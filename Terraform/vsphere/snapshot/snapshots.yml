#Terraform tool installer
steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
  displayName: 'Install Terraform latest'
  enabled: false

#init

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
  displayName: 'Terraform : Init'
  inputs:
    workingDirectory: '$(System.DefaultWorkingDirectory)/_Infraestructure/Terraform/vsphere/snapshot'
    backendServiceArm: 's-sis-eu-prod-01'
    backendAzureRmResourceGroupName: 'rg-shh-prod-devopsagents-01'
    backendAzureRmStorageAccountName: stproddevopsagent01
    backendAzureRmContainerName: 'terraform-status-file'
    backendAzureRmKey: 'kbY6VPrsDkqI6NXsJDaZauoanSEOp1I5KYDFPBFzBZIlKGsksxCUroinZF+lPz7JrbNiNwyUvnIR+AStlz9FJQ=='




#plan
variables:
  vm: 'proxyveeam'
  key: 'kbY6VPrsDkqI6NXsJDaZauoanSEOp1I5KYDFPBFzBZIlKGsksxCUroinZF+lPz7JrbNiNwyUvnIR+AStlz9FJQ=='

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
  displayName: 'Terraform : Plan'
  inputs:
    command: plan
    workingDirectory: '$(System.DefaultWorkingDirectory)/_Infraestructure/Terraform/vsphere/snapshot'
    commandOptions: '-input=false -var "vm=$(vm)"'
    environmentServiceNameAzureRM: 's-sis-eu-prod-01'
    backendServiceArm: 's-sis-eu-prod-01'
    backendAzureRmResourceGroupName: 'rg-shh-prod-devopsagents-01'
    backendAzureRmStorageAccountName: stproddevopsagent01
    backendAzureRmContainerName: 'terraform-status-file'
    backendAzureRmKey: '$(key)'


#apply
variables:
  vm: 'proxyveeam'
  key: 'kbY6VPrsDkqI6NXsJDaZauoanSEOp1I5KYDFPBFzBZIlKGsksxCUroinZF+lPz7JrbNiNwyUvnIR+AStlz9FJQ=='

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
  displayName: 'Terraform : Apply'
  inputs:
    command: apply
    workingDirectory: '$(System.DefaultWorkingDirectory)/_Infraestructure/Terraform/vsphere/snapshot'
    commandOptions: '-auto-approve -input=false -var "vm=$(vm)"'
    environmentServiceNameAzureRM: 's-sis-eu-prod-01'
    backendServiceArm: 's-sis-eu-prod-01'
    backendAzureRmResourceGroupName: 'rg-shh-prod-devopsagents-01'
    backendAzureRmStorageAccountName: stproddevopsagent01
    backendAzureRmContainerName: 'terraform-status-file'
    backendAzureRmKey: '$(key)'