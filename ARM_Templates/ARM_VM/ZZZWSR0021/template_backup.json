{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
"virtualMachineName": {
        "type": "string"
      },

        "virtualMachineRG": {
          "type": "string",
          "defaultValue": "",
          "metadata": {
            "description": "VM resource Group"
          }
      },
      "recoveryServiceVault": {
          "type": "string",
          "defaultValue": "",
          "metadata": {
            "description": "Recovery Service Vault used for"
          }
      },
      "backupPolicy": {
          "type": "string",
          "defaultValue": "",
          "metadata": {
            "description": "Backup policy"
          }
      }
    },
    "variables": {
      // Backup properties
      "backupvirtualMachineRG": "[virtualMachineRG().name]",
      //"recoveryServiceVaultName": "rsv-prod-euno-lrsbackup-01",
      //"backupPolicy": "vm-medium-01am-01",
      "backupFabric": "Azure",
      "protectionContainer": "[concat('iaasvmcontainer;iaasvmcontainerv2;', parameters('virtualMachineRG'), ';', parameters('virtualMachineName'))]",
      "protectedItem": "[concat('vm;iaasvmcontainerv2;', parameters('virtualMachineRG'), ';', parameters('virtualMachineName'))]"
    },
    "resources": [ 
      {  // Backups not working as it is trying to create it in the RG of the VMs. I don't know if we can specify a different RG for the backups
      "name": "[concat(parameters('recoveryServiceVault'), '/', variables('backupFabric'), '/', variables('protectionContainer'), '/', variables('protectedItem'))]",
      "apiVersion": "2016-12-01",
      "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
      "properties": {
        "protectedItemType": "Microsoft.Compute/virtualMachines",
        "policyId": "[resourceId(variables('backupvirtualMachineRG'), 'Microsoft.RecoveryServices/vaults/backupPolicies',parameters('recoveryServiceVault'), parameters('backupPolicy'))]",
        "sourceResourceId": "[resourceId(parameters('virtualMachineRG'),'Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
      }
      }
    ],
    "outputs": {
    }
  }
  
